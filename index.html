<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Werkprogramma Vergunningbeoordeling</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <span><span class="material-icons header-logo">dashboard</span>Werkprogramma Vergunningbeoordeling</span>
        <span class="version">vDemo</span>
        <button class="docs-button" onclick="openDocumentation()">
            <span class="material-icons">description</span>
            <span class="tooltip">Documentatie
                <span class="tooltiptext">Opent in nieuw tabblad</span>
            </span>
        </button>
    </header>
    
<div class="info-bar">
    <div class="info-group">
        <span>Aanvraagnummer: <strong>2025-00087</strong></span>
        <span>Indieningsdatum: <strong>02-06-2025</strong></span>
        <span>Status: <span class="status-badge status-nieuw" id="main-status">Nieuw</span></span>
    </div>
    <div class="info-group">
        <span>Aanvrager: <strong>Stichting Virtueel Geduld</strong></span>
        <span>Contact: <strong>jane.doe@email.nl</strong></span>
    </div>
</div>

<div class="dashboard-section">
    <div class="dashboard-flex">
        <div class="left-col">
            <div class="section-card overview-card">
                <div class="section-header">
                    <span class="material-icons">info</span>Overzicht
                </div>
                
                <div class="overview-grid">
                    <div class="process-status">
                        <div class="process-item">
                            <div class="process-label">AT</div>
                            <div class="process-icon" id="at-status">⏳</div>
                            <div class="process-status-text" id="at-text">In behandeling</div>
                            <select class="process-select" id="at-select" onchange="updateProcessStatus('at', this.value)">
                                <option value="pending">In behandeling</option>
                                <option value="completed">Afgerond</option>
                                <option value="not-started">Niet gestart</option>
                            </select>
                        </div>
                        <div class="process-item">
                            <div class="process-label">KIT</div>
                            <div class="process-icon" id="kit-status">❌</div>
                            <div class="process-status-text" id="kit-text">Nog niet ontvangen</div>
                            <select class="process-select" id="kit-select" onchange="updateProcessStatus('kit', this.value)">
                                <option value="not-received">Niet ontvangen</option>
                                <option value="received">Ontvangen</option>
                                <option value="pending">In behandeling</option>
                            </select>
                        </div>
                        <div class="process-item">
                            <div class="process-label">LSR</div>
                            <div class="process-icon" id="lsr-status">❌</div>
                            <div class="process-status-text" id="lsr-text">Nog niet gecheckt</div>
                            <select class="process-select" id="lsr-select" onchange="updateProcessStatus('lsr', this.value)">
                                <option value="not-checked">Niet gecheckt</option>
                                <option value="checked">Gecheckt</option>
                                <option value="pending">In behandeling</option>
                            </select>
                        </div>
                        <div class="process-item">
                            <div class="process-label">DNB</div>
                            <div class="process-icon" id="dnb-status">✅</div>
                            <div class="process-status-text" id="dnb-text">Ontvangen</div>
                            <select class="process-select" id="dnb-select" onchange="updateProcessStatus('dnb', this.value)">
                                <option value="received">Ontvangen</option>
                                <option value="not-received">Niet ontvangen</option>
                                <option value="pending">In behandeling</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="deadline-timeline">
                        <div class="timeline-item">
                            <span class="timeline-label">Datum ontvangst:</span>
                            <span class="timeline-value" id="receive-date">02-06-2025</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Normdatum:</span>
                            <span class="timeline-value" id="deadline-date">02-08-2025</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Resterend:</span>
                            <span class="timeline-value" id="remaining-days">Nog 52 dagen</span>
                        </div>
                        <div class="timeline-progress">
                            <div class="timeline-progress-bar" id="timeline-bar"></div>
                        </div>
                        <div class="timeline-warning" id="timeline-warning">
                            ⚠ Deadline nadert! Nog 10 dagen over.
                        </div>
                    </div>
                </div>
                
                <div class="metrics-bar">
                    <div class="metric-card">
                        <span class="material-icons metric-icon">assignment</span>
                        <div>
                            <div class="metric-label">Aantal Thema's</div>
                            <div class="metric-value" id="themaCount">4</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <span class="material-icons metric-icon warning-icon">warning</span>
                        <div>
                            <div class="metric-label">Hoog risico</div>
                            <div class="metric-value" id="highRiskCount">1</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <span class="material-icons metric-icon pending-icon">hourglass_top</span>
                        <div>
                            <div class="metric-label">Niet beoordeeld</div>
                            <div class="metric-value" id="notReviewedCount">4</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <span class="material-icons metric-icon success-icon">how_to_reg</span>
                        <div>
                            <div class="metric-label">Goedgekeurd</div>
                            <div class="metric-value" id="approvedCount">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="status-history-accordion">
                    <div class="accordion-header" onclick="toggleStatusHistory()">
                        <span class="material-icons expand-icon">chevron_right</span>
                        <span class="material-icons">history</span>
                        Statusgeschiedenis
                    </div>
                    <div class="accordion-content" id="statusHistory"></div>
                </div>
                
                <div class="filters">
                    <label for="filter-theme">Filter thema:</label>
                    <select id="filter-theme">
                        <option value="all">Alle</option>
                        <option value="Governance">Governance</option>
                        <option value="IT">IT</option>
                        <option value="Risk Management">Risk Management</option>
                        <option value="Compliance">Compliance</option>
                    </select>
                    
                    <label for="filter-risk">Risico:</label>
                    <select id="filter-risk">
                        <option value="Hoog">Hoog</option>
                        <option value="Midden">Midden</option>
                        <option value="Laag">Laag</option>
                        <option value="all">Alle</option>

                    </select>
                    
                    <label for="filter-status">Beoordeling:</label>
                    <select id="filter-status">
                        <option value="all">Alle</option>
                        <option value="Goedgekeurd">Goedgekeurd</option>
                        <option value="Afgekeurd">Afgekeurd</option>
                        <option value="Nog niet beoordeeld">Nog niet beoordeeld</option>
                    </select>
                </div>
            </div>
            
            <div class="bookmark-bar">
                <span>Thema:</span>
                <button class="bookmark-btn" onclick="scrollToAccordion('Governance')">Governance</button>
                <button class="bookmark-btn" onclick="scrollToAccordion('IT')">IT</button>
                <button class="bookmark-btn" onclick="scrollToAccordion('Risk Management')">Risk Management</button>
                <button class="bookmark-btn" onclick="scrollToAccordion('Compliance')">Compliance</button>
            </div>
            
            <div id="accordion" class="accordion"></div>
            
            <div id="notReviewedWarning" class="warning" style="display:none;">
                Niet alle thema's zijn beoordeeld! Controleer het werkprogramma.
            </div>
            
            <div id="vervolgactieSection" class="vervolg-section" style="display:none;">
                <div class="vervolg-header">
                    <span class="material-icons">question_answer</span> Vervolgactie: Stel een vraag aan de aanvrager
                </div>
                <div class="vervolg-form">
                    <div>
                        <label for="vervolgQuestion">Uw vraag:</label>
                        <textarea id="vervolgQuestion" placeholder="Typ hier uw vraag aan de aanvrager..."></textarea>
                    </div>
                    <div class="vervolg-actions">
                        <button class="vervolg-btn vervolg-send-btn" onclick="sendVervolgQuestion()">Verstuur vraag</button>
                        <button class="vervolg-btn vervolg-cancel-btn" onclick="cancelVervolgQuestion()">Annuleren</button>
                    </div>
                </div>
                <div id="vervolgResponse" class="vervolg-response">
                    <div class="vervolg-header">
                        <span class="material-icons">assignment_turned_in</span> Ontvangen antwoord
                    </div>
                    <div id="vervolgAnswerText"></div>
                    <div class="vervolg-actions" style="margin-top:1em;">
                        <button class="vervolg-btn" onclick="acceptAnswer()">Antwoord accepteren</button>
                        <button class="vervolg-btn vervolg-cancel-btn" onclick="requestClarification()">Verduidelijking vragen</button>
                    </div>
                </div>
                <div id="vervolgHistory" class="vervolg-history">
                    <div class="vervolg-header">
                        <span class="material-icons">history</span> Geschiedenis van vervolgacties
                    </div>
                    <div id="vervolgHistoryContent"></div>
                </div>
            </div>
            
            <div class="decision-container">
                <div class="go-indicator">
                    <span class="go-status nogo" id="goIndicator">NO GO</span>
                </div>
                
                <div class="final-decision">
                    <div class="decision-title">Definitieve beslissing</div>
                    <p>Na beoordeling van alle thema's kunt u hier de definitieve beslissing nemen:</p>
                    
                    <div class="decision-notes">
                        <label for="decisionNotes">Aanvullende opmerkingen:</label>
                        <textarea id="decisionNotes" placeholder="Voeg hier aanvullende opmerkingen toe, zoals voorschriften/beperkingen, red flags voor doorlopend toezicht, overzicht bestaande fondsen en AuM's, of relevante aandachtspunten uit het feitenoverzicht." maxlength="1000"></textarea>
                        <div class="char-counter"><span id="charCount">0</span>/1000 tekens</div>
                    </div>
                    
                    <div class="decision-options">
                        <button class="decision-btn approve-btn" onclick="showConfirmation('approve')">Vergunning verlenen</button>
                        <button class="decision-btn reject-btn" onclick="showConfirmation('reject')">Vergunning weigeren</button>
                    </div>
                    <div id="decisionConfirmation" class="decision-confirmation">
                        <div class="confirmation-title" id="confirmationTitle">Vergunning verleend!</div>
                        <div class="confirmation-text" id="confirmationText">
                            U heeft besloten de vergunning te verlenen. Deze beslissing wordt nu definitief gemaakt.
                        </div>
                        <div class="confirmation-actions">
                            <button onclick="finalizeDecision()">Bevestigen</button>
                            <button onclick="cancelDecision()">Annuleren</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-col">
            <div class="section-card risk-overview">
                <div class="section-header">
                    <span class="material-icons">assessment</span>Risico-overzicht
                </div>
                <div class="charts-row">
                    <canvas id="riskBarChart" class="risk-bar-chart"></canvas>
                    <canvas id="spiderDiagram" class="spider-diagram"></canvas>
                </div>
                <div class="legend">
                    <span><span class="legend-box bar-red"></span>Hoog</span>
                    <span><span class="legend-box bar-orange"></span>Midden</span>
                    <span><span class="legend-box bar-green"></span>Laag</span>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Process status data
        const processStatus = {
            at: { status: 'pending', text: 'In behandeling', lastUpdate: '05-06-2025' },
            kit: { status: 'not-received', text: 'Nog niet ontvangen', lastUpdate: '' },
            lsr: { status: 'not-checked', text: 'Nog niet gecheckt', lastUpdate: '' },
            dnb: { status: 'received', text: 'Ontvangen', lastUpdate: '10-06-2025' }
        };

        // Function to update process status
        function updateProcessStatus(process, newStatus) {
            processStatus[process].status = newStatus;
            processStatus[process].lastUpdate = new Date().toLocaleDateString('nl-NL');
            renderProcessStatus();
            addStatusHistory(`${process.toUpperCase()} status gewijzigd naar: ${getStatusText(process, newStatus)}`);
        }

        // Helper function to get status text
        function getStatusText(process, status) {
            const statusTexts = {
                at: {
                    'pending': 'In behandeling',
                    'completed': 'Afgerond',
                    'not-started': 'Niet gestart'
                },
                kit: {
                    'not-received': 'Niet ontvangen',
                    'received': 'Ontvangen',
                    'pending': 'In behandeling'
                },
                lsr: {
                    'not-checked': 'Niet gecheckt',
                    'checked': 'Gecheckt',
                    'pending': 'In behandeling'
                },
                dnb: {
                    'received': 'Ontvangen',
                    'not-received': 'Niet ontvangen',
                    'pending': 'In behandeling'
                }
            };
            return statusTexts[process][status] || status;
        }

        // Updated renderProcessStatus function
        function renderProcessStatus() {
            // AT Status
            const atEl = document.getElementById('at-status');
            const atTextEl = document.getElementById('at-text');
            const atSelect = document.getElementById('at-select');
            
            if (processStatus.at.status === 'completed') {
                atEl.textContent = '✅';
                atEl.style.color = 'var(--success)';
                atTextEl.textContent = 'Afgerond (' + processStatus.at.lastUpdate + ')';
                atSelect.value = 'completed';
            } else if (processStatus.at.status === 'pending') {
                atEl.textContent = '⏳';
                atEl.style.color = 'var(--medium)';
                atTextEl.textContent = 'In behandeling';
                atSelect.value = 'pending';
            } else {
                atEl.textContent = '❌';
                atEl.style.color = 'var(--danger)';
                atTextEl.textContent = 'Niet gestart';
                atSelect.value = 'not-started';
            }
            
            // KIT Status
            const kitEl = document.getElementById('kit-status');
            const kitTextEl = document.getElementById('kit-text');
            const kitSelect = document.getElementById('kit-select');
            
            if (processStatus.kit.status === 'received') {
                kitEl.textContent = '✅';
                kitEl.style.color = 'var(--success)';
                kitTextEl.textContent = 'Ontvangen (' + processStatus.kit.lastUpdate + ')';
                kitSelect.value = 'received';
            } else if (processStatus.kit.status === 'pending') {
                kitEl.textContent = '⏳';
                kitEl.style.color = 'var(--medium)';
                kitTextEl.textContent = 'In behandeling';
                kitSelect.value = 'pending';
            } else {
                kitEl.textContent = '❌';
                kitEl.style.color = 'var(--danger)';
                kitTextEl.textContent = 'Nog niet ontvangen';
                kitSelect.value = 'not-received';
            }
            
            // LSR Status
            const lsrEl = document.getElementById('lsr-status');
            const lsrTextEl = document.getElementById('lsr-text');
            const lsrSelect = document.getElementById('lsr-select');
            
            if (processStatus.lsr.status === 'checked') {
                lsrEl.textContent = '✅';
                lsrEl.style.color = 'var(--success)';
                lsrTextEl.textContent = 'Gecheckt (' + processStatus.lsr.lastUpdate + ')';
                lsrSelect.value = 'checked';
            } else if (processStatus.lsr.status === 'pending') {
                lsrEl.textContent = '⏳';
                lsrEl.style.color = 'var(--medium)';
                lsrTextEl.textContent = 'In behandeling';
                lsrSelect.value = 'pending';
            } else {
                lsrEl.textContent = '❌';
                lsrEl.style.color = 'var(--danger)';
                lsrTextEl.textContent = 'Nog niet gecheckt';
                lsrSelect.value = 'not-checked';
            }
            
            // DNB Status
            const dnbEl = document.getElementById('dnb-status');
            const dnbTextEl = document.getElementById('dnb-text');
            const dnbSelect = document.getElementById('dnb-select');
            
            if (processStatus.dnb.status === 'received') {
                dnbEl.textContent = '✅';
                dnbEl.style.color = 'var(--success)';
                dnbTextEl.textContent = 'Ontvangen (' + processStatus.dnb.lastUpdate + ')';
                dnbSelect.value = 'received';
            } else if (processStatus.dnb.status === 'pending') {
                dnbEl.textContent = '⏳';
                dnbEl.style.color = 'var(--medium)';
                dnbTextEl.textContent = 'In behandeling';
                dnbSelect.value = 'pending';
            } else {
                dnbEl.textContent = '❌';
                dnbEl.style.color = 'var(--danger)';
                dnbTextEl.textContent = 'Nog niet ontvangen';
                dnbSelect.value = 'not-received';
            }
        }

        // Function to add status history entry
        function addStatusHistory(text) {
            statusHistory.push({
                status: text,
                date: new Date().toLocaleDateString('nl-NL'),
                by: "Beoordelaar"
            });
            renderStatusHistory();
        }

        // Rest of your existing JavaScript code...
        // (All the other functions from your original script should remain the same)
        // Placeholder DATA -- you can easily map this to an API or back-end
        const THEMES = [
            {
                name: "Governance",
                icon: "account_balance",
                risk: "Hoog",
                riskScore: 85,
                context: "Bestuur, structuur en toezicht binnen de organisatie.",
                applicantAnswers: [
                    { question: "Heeft uw organisatie een bestuursstructuur?", answer: "Ja, met maandelijkse vergaderingen.", score: 5 },
                    { question: "Zijn verantwoordelijkheden duidelijk vastgelegd?", answer: "Ja, in het organigram.", score: 4 }
                ]
            },
            {
                name: "IT",
                icon: "computer",
                risk: "Hoog",
                riskScore: 55,
                context: "Beheer, beveiliging en continuïteit van IT-systemen.",
                applicantAnswers: [
                    { question: "Zijn kritieke IT-systemen beveiligd?", answer: "Basisbeveiliging aanwezig.", score: 3 },
                    { question: "Worden back-ups getest?", answer: "Niet structureel.", score: 2 }
                ]
            },
            {
                name: "Risk Management",
                icon: "report_problem",
                risk: "Hoog",
                riskScore: 28,
                context: "Proces voor identificatie, beoordeling en beheersing van risico's.",
                applicantAnswers: [
                    { question: "Is er een risicobeoordelingsproces?", answer: "Jaarlijks uitgevoerd.", score: 5 },
                    { question: "Hoe wordt omgegaan met incidenten?", answer: "Direct gemeld aan management.", score: 5 }
                ]
            },
            {
                name: "Compliance",
                icon: "gavel",
                risk: "Hoog",
                riskScore: 45,
                context: "Naleving van relevante wet- en regelgeving.",
                applicantAnswers: [
                    { question: "Voldoet u aan relevante wetgeving?", answer: "Grotendeels, sommige punten aandacht nodig.", score: 3 },
                    { question: "Zijn compliance-trainingen verplicht?", answer: "Niet voor alle medewerkers.", score: 2 }
                ]
            },
                        {
                name: "Beloningsbeleid",
                icon: "attach_money",
                risk: "Laag",
                riskScore: 20,
                context: "Naleving van relevante wet- en regelgeving.",
                applicantAnswers: [
        { question: "Is het beloningsbeleid transparant voor alle medewerkers?", answer: "Ja, jaarlijks gecommuniceerd via interne nieuwsbrief.", score: 4 },
        { question: "Worden bonussen eerlijk en volgens vooraf vastgestelde criteria toegekend?", answer: "Ja, op basis van KPI’s en jaarlijkse evaluaties.", score: 5 },
        { question: "Zijn er procedures voor het aanpassen van salarissen?", answer: "Ja, met input van HR en directie.", score: 4 }
                ]
            },
            {
    name: "Wwft / AML",
    icon: "visibility", // Because someone’s always watching the money flow
    risk: "Middel",
    riskScore: 60,
    context: "Beleid en maatregelen ter voorkoming van witwassen en terrorismefinanciering.",
    applicantAnswers: [
        { question: "Heeft uw organisatie een Wwft-compliant beleid?", answer: "Ja, jaarlijks geüpdatet en getoetst.", score: 5 },
        { question: "Worden medewerkers getraind in het herkennen van verdachte transacties?", answer: "Ja, verplichte trainingen voor risicoposities.", score: 4 },
        { question: "Zijn er procedures voor melding van ongebruikelijke transacties?", answer: "Ja, directe rapportage aan compliance officer.", score: 5 }
    ]
}

            
        ];

        // Vervolgactie history
        let vervolgHistory = [];
        let currentVervolgTheme = null;

        // Initieel & Reviewer status per thema (simulatie)
        let themeReviews = {}; // {themeName: { status, remark, vervolg, reviewer: {status, remark, vervolg}}}
        let statusHistory = [
            { status: 'Nieuw', date: '02-06-2025', by: 'Systeem' }
        ];
        
        // Deadline data (Feature C)
        const deadlineData = {
            receiveDate: '02-06-2025',
            deadlineDate: '02-08-2025', // 2 months later
            daysRemaining: 52 // Will be calculated dynamically
        };

        // --- Render Metrics ---
        function renderMetrics() {
            document.getElementById('themaCount').textContent = THEMES.length;
            document.getElementById('highRiskCount').textContent = THEMES.filter(t => t.risk === 'Hoog').length;
            document.getElementById('notReviewedCount').textContent =
                THEMES.filter(t => !themeReviews[t.name] || (themeReviews[t.name].status === "Nog niet beoordeeld")).length;
            document.getElementById('approvedCount').textContent =
                THEMES.filter(t => themeReviews[t.name] && themeReviews[t.name].status === "Goedgekeurd").length;
        }

        // --- Statusgeschiedenis ---
        function renderStatusHistory() {
            const hist = statusHistory.map(entry =>
                `<div class="status-history-entry">
                    <span class="material-icons" style="font-size:1.09em;vertical-align:-0.18em;">history</span>
                    <strong>${entry.status}</strong> (${entry.date}) <span style="color:#7d8a99;">${entry.by}</span>
                </div>`
            ).join('');
            document.getElementById('statusHistory').innerHTML =
                '<div class="status-history-title">Statusgeschiedenis:</div>' + hist;
        }
        
        // Toggle status history visibility
        function toggleStatusHistory() {
            const content = document.getElementById('statusHistory');
            const icon = document.querySelector('.status-history-accordion .expand-icon');
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
            icon.textContent = content.style.display === 'none' ? 'chevron_right' : 'expand_more';
        }
        
        // NEW: Calculate and render deadline timeline (Feature C)
        function renderDeadlineTimeline() {
            // Set dates
            document.getElementById('receive-date').textContent = deadlineData.receiveDate;
            document.getElementById('deadline-date').textContent = deadlineData.deadlineDate;
            
            // Calculate days remaining (simple example - in a real app you'd use actual date diff)
            const daysRemaining = deadlineData.daysRemaining;
            document.getElementById('remaining-days').textContent = `Nog ${daysRemaining} dagen`;
            
            // Calculate percentage (assuming total period is 60 days)
            const percentage = Math.min(100, Math.max(0, ((60 - daysRemaining) / 60) * 100));
            const progressBar = document.getElementById('timeline-bar');
            progressBar.style.width = `${percentage}%`;
            
            // Update color based on urgency
            const warningEl = document.getElementById('timeline-warning');
            if (daysRemaining <= 10) {
                progressBar.style.backgroundColor = 'var(--warning-orange)';
                if (daysRemaining <= 5) {
                    progressBar.style.backgroundColor = 'var(--danger)';
                }
                warningEl.style.display = 'block';
                warningEl.textContent = `⚠ Deadline nadert! Nog ${daysRemaining} dagen over.`;
                if (daysRemaining <= 3) {
                    warningEl.style.color = 'var(--danger)';
                    warningEl.textContent = `⚠ Dringend! Deadline over ${daysRemaining} dagen!`;
                }
            } else {
                progressBar.style.backgroundColor = 'var(--success)';
                warningEl.style.display = 'none';
            }
        }
        
        // NEW: Handle decision notes character count (Feature A)
        function setupDecisionNotes() {
            const textarea = document.getElementById('decisionNotes');
            const charCount = document.getElementById('charCount');
            
            textarea.addEventListener('input', function() {
                const remaining = 1000 - this.value.length;
                charCount.textContent = this.value.length;
                
                // Auto-save to localStorage (simulated)
                localStorage.setItem('decisionNotes', this.value);
            });
            
            // Load saved notes if any
            const savedNotes = localStorage.getItem('decisionNotes');
            if (savedNotes) {
                textarea.value = savedNotes;
                charCount.textContent = savedNotes.length;
            }
        }
        
        // NEW: Open documentation (Feature D)
        function openDocumentation() {
            // In a real app, this would open a modal or link to external docs
            const docUrl = "https://example.com/documentatie-vergunningen";
            window.open(docUrl, '_blank');
            
            // Alternatively, you could show a modal with embedded content
            // showDocumentationModal();
        }

        // --- Filtering helpers ---
        function filterTheme(theme) {
            let val = document.getElementById('filter-theme').value;
            return val === "all" || theme.name === val;
        }
        function filterRisk(theme) {
            let val = document.getElementById('filter-risk').value;
            if (val === "all") return true;
            return theme.risk === val;
        }
        function filterStatus(theme) {
            let val = document.getElementById('filter-status').value;
            if (val === "all") return true;
            let review = themeReviews[theme.name] || { status: "Nog niet beoordeeld" };
            return review.status === val;
        }
        document.getElementById('filter-theme').addEventListener('change', renderAccordion);
        document.getElementById('filter-risk').addEventListener('change', renderAccordion);
        document.getElementById('filter-status').addEventListener('change', renderAccordion);

        // --- Accordion rendering ---
        function renderAccordion() {
            const accordion = document.getElementById('accordion');
            accordion.innerHTML = '';
            THEMES.forEach(theme => {
                // Filter logic
                if (!(filterTheme(theme) && filterRisk(theme) && filterStatus(theme))) return;

                // Status info
                let review = themeReviews[theme.name] || {
                    status: "Nog niet beoordeeld",
                    remark: "",
                    vervolg: "Nee",
                    reviewer: {
                        status: "Nog niet beoordeeld",
                        remark: "",
                        vervolg: "Nee"
                    }
                };

                let statusColor = review.status === "Goedgekeurd" ? "review-status-goedgekeurd" :
                                  review.status === "Afgekeurd" ? "review-status-afgekeurd" :
                                  "review-status-niet";
                let reviewerStatusColor = review.reviewer && review.reviewer.status === "Goedgekeurd" ? "review-status-goedgekeurd" :
                                         review.reviewer && review.reviewer.status === "Afgekeurd" ? "review-status-afgekeurd" :
                                         "review-status-niet";

                let reviewerMeta = "";
                if (review.reviewer && review.reviewer.status !== "Nog niet beoordeeld") {
                    reviewerMeta = `<div class="reviewer-meta">
                        <span class="material-icons" style="font-size:1em;vertical-align:-0.13em;">supervisor_account</span>
                        Reviewer: <span class="review-status-badge ${reviewerStatusColor}">${review.reviewer.status}</span>
                        <span style="color:#989fba;">${review.reviewer.remark ? "Opmerking: "+review.reviewer.remark : ""}</span>
                    </div>`;
                }
                
                // Vervolgactie history for this theme
                const themeVervolgHistory = vervolgHistory.filter(item => item.theme === theme.name);
                const vervolgHistoryHTML = themeVervolgHistory.map(item => `
                    <div class="vervolg-history-item">
                        <div class="vervolg-history-question">${item.question}</div>
                        <div class="vervolg-history-answer">${item.answer || '<em>Nog geen antwoord</em>'}</div>
                        <div class="vervolg-history-date">${item.date}</div>
                    </div>
                `).join('');
                
                // Accordion
                accordion.innerHTML += `
                <div class="accordion-item" id="item-${theme.name}">
                    <div class="accordion-header" onclick="toggleAccordion('${theme.name}')">
                        <span class="expand-icon material-icons">chevron_right</span> 
                        <span class="theme-icon material-icons">${theme.icon}</span>
                        ${theme.name}
                        <span style="margin-left:auto;">
                            <span class="review-status-badge ${statusColor}">
                                ${review.status}
                            </span>
                        </span>
                    </div>
                    <div class="accordion-content">
                        <div class="theme-context">${theme.context}</div>
                        <div class="applicant-answers">
                            ${theme.applicantAnswers.map(ans =>
                                `<div class="question-block">
                                    <strong>${ans.question}</strong>
                                    <div class="applicant-answer">${ans.answer} <span class="score-label">Score: ${ans.score}</span></div>
                                </div>`
                            ).join('')}
                        </div>
                        <div>
                            <label for="remark-${theme.name}">Opmerkingen beoordelaar:</label><br>
                            <textarea class="remark-field" id="remark-${theme.name}" 
                                placeholder="Typ hier uw opmerkingen...">${review.remark || ""}</textarea>
                        </div>
                        <div class="review-section">
                            <span class="review-label">Status beoordeling:</span>
                            <span class="reviewer-ctrl-group">
                                <select id="status-${theme.name}" onchange="updateReview('${theme.name}')">
                                    <option value="Nog niet beoordeeld" ${review.status === "Nog niet beoordeeld" ? "selected" : ""}>Nog niet beoordeeld</option>
                                    <option value="Goedgekeurd" ${review.status === "Goedgekeurd" ? "selected" : ""}>Goedgekeurd</option>
                                    <option value="Afgekeurd" ${review.status === "Afgekeurd" ? "selected" : ""}>Afgekeurd</option>
                                </select>
                            </span>
                            <span class="review-label">Noodzaak vervolgactie?</span>
                            <span class="reviewer-ctrl-group">
                                <select id="vervolg-${theme.name}" onchange="handleVervolgChange('${theme.name}')">
                                    <option value="Nee" ${review.vervolg === "Nee" ? "selected" : ""}>Nee</option>
                                    <option value="Ja" ${review.vervolg === "Ja" ? "selected" : ""}>Ja</option>
                                </select>
                            </span>
                        </div>
                        ${reviewerMeta}
                        
                        <!-- Vervolgactie History -->
                        ${vervolgHistoryHTML ? `
                        <div class="vervolg-history">
                            <div class="vervolg-header">
                                <span class="material-icons">history</span> Vervolgactie geschiedenis
                            </div>
                            ${vervolgHistoryHTML}
                        </div>
                        ` : ''}
                        
                        <div class="reviewer-flow">
                            <details>
                                <summary style="cursor:pointer;font-size:1.04em;">
                                    <span class="material-icons" style="vertical-align:-0.23em;color:var(--primary);">done_all</span>
                                    Reviewer beoordeling (tweede lijn)
                                </summary>
                                <div class="reviewer-row">
                                    <span class="review-label">Status reviewer:</span>
                                    <span class="reviewer-ctrl-group">
                                        <select id="rev-status-${theme.name}" onchange="updateReviewer('${theme.name}')">
                                            <option value="Nog niet beoordeeld" ${review.reviewer.status === "Nog niet beoordeeld" ? "selected" : ""}>Nog niet beoordeeld</option>
                                            <option value="Goedgekeurd" ${review.reviewer.status === "Goedgekeurd" ? "selected" : ""}>Goedgekeurd</option>
                                            <option value="Afgekeurd" ${review.reviewer.status === "Afgekeurd" ? "selected" : ""}>Afgekeurd</option>
                                        </select>
                                    </span>
                                    <span class="review-label">Noodzaak vervolgactie?</span>
                                    <span class="reviewer-ctrl-group">
                                        <select id="rev-vervolg-${theme.name}" onchange="updateReviewer('${theme.name}')">
                                            <option value="Nee" ${review.reviewer.vervolg === "Nee" ? "selected" : ""}>Nee</option>
                                            <option value="Ja" ${review.reviewer.vervolg === "Ja" ? "selected" : ""}>Ja</option>
                                        </select>
                                    </span>
                                </div>
                                <div>
                                    <label for="rev-remark-${theme.name}">Opmerking reviewer:</label><br>
                                    <textarea class="remark-field" id="rev-remark-${theme.name}" 
                                        placeholder="Typ hier uw opmerkingen...">${review.reviewer.remark || ""}</textarea>
                                </div>
                                <button class="bookmark-btn" style="margin-top:0.8em;font-size:0.97em;" onclick="saveReviewer('${theme.name}')">Reviewer opslaan</button>
                            </details>
                        </div>
                    </div>
                </div>
                `;
            });
            updateWarning();
            renderMetrics();
        }

        // --- Accordion expand/collapse ---
        function toggleAccordion(themeName) {
            let el = document.getElementById(`item-${themeName}`);
            if (el.classList.contains('open')) {
                el.classList.remove('open');
            } else {
                // Close others
                document.querySelectorAll('.accordion-item').forEach(item => item.classList.remove('open'));
                el.classList.add('open');
            }
        }

        // --- Bookmark scroll ---
        function scrollToAccordion(themeName) {
            let el = document.getElementById(`item-${theme.name}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => el.classList.add('open'), 250);
            }
        }

        // --- Vervolgactie handling ---
        function handleVervolgChange(themeName) {
            const vervolg = document.getElementById(`vervolg-${themeName}`).value;
            
            // Update the review object
            if (!themeReviews[themeName]) {
                themeReviews[themeName] = {
                    status: "Nog niet beoordeeld",
                    remark: "",
                    vervolg: vervolg,
                    reviewer: { status: "Nog niet beoordeeld", remark: "", vervolg: "Nee" }
                };
            } else {
                themeReviews[themeName].vervolg = vervolg;
            }
            
            // Show vervolgactie section if "Ja" is selected
            if (vervolg === "Ja") {
                currentVervolgTheme = themeName;
                document.getElementById('vervolgactieSection').style.display = 'block';
                document.getElementById('vervolgQuestion').value = '';
                document.getElementById('vervolgResponse').classList.remove('show');
                
                // Scroll to vervolg section
                document.getElementById('vervolgactieSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                document.getElementById('vervolgactieSection').style.display = 'none';
            }
            
            renderAccordion();
        }

        function sendVervolgQuestion() {
            const question = document.getElementById('vervolgQuestion').value.trim();
            if (!question) {
                alert('Vul een vraag in');
                return;
            }
            
            // Add to history
            vervolgHistory.push({
                theme: currentVervolgTheme,
                question: question,
                answer: "",
                date: new Date().toLocaleDateString('nl-NL') + ' ' + new Date().toLocaleTimeString('nl-NL')
            });
            
            // Update UI
            document.getElementById('vervolgQuestion').value = '';
            document.getElementById('vervolgResponse').classList.add('show');
            document.getElementById('vervolgAnswerText').innerHTML = `
                <p><strong>Uw vraag:</strong> ${question}</p>
                <p><strong>Status:</strong> Wachten op antwoord van aanvrager</p>
            `;
            
            // Update status history
            statusHistory.push({
                status: `Vervolgvraag gesteld voor ${currentVervolgTheme}`,
                date: new Date().toLocaleDateString("nl-NL"),
                by: "Beoordelaar"
            });
            renderStatusHistory();
            renderAccordion();
        }

        function cancelVervolgQuestion() {
            document.getElementById('vervolgactieSection').style.display = 'none';
            // Reset vervolg selection
            if (currentVervolgTheme) {
                document.getElementById(`vervolg-${currentVervolgTheme}`).value = "Nee";
                if (themeReviews[currentVervolgTheme]) {
                    themeReviews[currentVervolgTheme].vervolg = "Nee";
                }
            }
            currentVervolgTheme = null;
        }

        function acceptAnswer() {
            const lastQuestion = vervolgHistory[vervolgHistory.length - 1];
            if (lastQuestion) {
                lastQuestion.answer = document.getElementById('vervolgAnswerText').innerText;
                
                // Update status
                statusHistory.push({
                    status: `Antwoord geaccepteerd voor ${currentVervolgTheme}`,
                    date: new Date().toLocaleDateString("nl-NL"),
                    by: "Beoordelaar"
                });
                
                // Close vervolg section
                document.getElementById('vervolgactieSection').style.display = 'none';
                currentVervolgTheme = null;
                
                renderStatusHistory();
                renderAccordion();
                alert('Antwoord geaccepteerd!');
            }
        }

        function requestClarification() {
            document.getElementById('vervolgQuestion').value = 
                "Kunt u meer details geven over uw vorige antwoord?";
            document.getElementById('vervolgResponse').classList.remove('show');
        }

        // --- Review handling ---
        function updateReview(themeName) {
            // Snarky field validation? Of course.
            let remark = document.getElementById(`remark-${themeName}`).value;
            let status = document.getElementById(`status-${themeName}`).value;
            let vervolg = document.getElementById(`vervolg-${themeName}`).value;
            if (!themeReviews[themeName]) {
                themeReviews[themeName] = {
                    status: status,
                    remark: remark,
                    vervolg: vervolg,
                    reviewer: { status: "Nog niet beoordeeld", remark: "", vervolg: "Nee" }
                };
            } else {
                themeReviews[themeName].status = status;
                themeReviews[themeName].remark = remark;
                themeReviews[themeName].vervolg = vervolg;
            }
            // Statusgeschiedenis bijwerken
            let prev = statusHistory[statusHistory.length-1];
            if (prev.status !== status && status !== "Nog niet beoordeeld") {
                statusHistory.push({
                    status: `${themeName}: ${status}`,
                    date: new Date().toLocaleDateString("nl-NL"),
                    by: "Beoordelaar"
                });
            }
            renderAccordion();
            updateGoIndicator();
            renderStatusHistory();
        }

        // --- Reviewer handling (details section) ---
        function updateReviewer(themeName) {
            let review = themeReviews[themeName] || {
                status: "Nog niet beoordeeld", remark: "", vervolg: "Nee",
                reviewer: { status: "Nog niet beoordeeld", remark: "", vervolg: "Nee" }
            };
            let revStatus = document.getElementById(`rev-status-${themeName}`).value;
            let revRemark = document.getElementById(`rev-remark-${themeName}`).value;
            let revVervolg = document.getElementById(`rev-vervolg-${themeName}`).value;
            review.reviewer = {
                status: revStatus,
                remark: revRemark,
                vervolg: revVervolg
            };
            themeReviews[themeName] = review;
        }
        function saveReviewer(themeName) {
            updateReviewer(themeName);
            let rev = themeReviews[themeName].reviewer;
            if (rev.status && rev.status !== "Nog niet beoordeeld") {
                statusHistory.push({
                    status: `${themeName}: Reviewer ${rev.status}`,
                    date: new Date().toLocaleDateString("nl-NL"),
                    by: "Reviewer"
                });
            }
            renderAccordion();
            updateGoIndicator();
            renderStatusHistory();
        }

        // --- Not all reviewed warning ---
        function updateWarning() {
            let allReviewed = THEMES.every(theme =>
                (themeReviews[theme.name] || { status: "Nog niet beoordeeld" }).status !== "Nog niet beoordeeld"
            );
            document.getElementById('notReviewedWarning').style.display = allReviewed ? "none" : "";
        }

        // --- Go/No-Go logic ---
        function updateGoIndicator() {
            let anyRejected = THEMES.some(theme =>
                (themeReviews[theme.name] || { status: "Nog niet beoordeeld" }).status === "Afgekeurd"
            );
            let allApproved = THEMES.every(theme =>
                (themeReviews[theme.name] || { status: "Nog niet beoordeeld" }).status === "Goedgekeurd"
            );
            let statusEl = document.getElementById('goIndicator');
            let mainStatus = document.getElementById('main-status');
            if (anyRejected) {
                statusEl.textContent = "NO GO";
                statusEl.className = "go-status nogo";
                mainStatus.textContent = "Geweigerd";
                mainStatus.className = "status-badge status-geweigerd";
            } else if (allApproved) {
                statusEl.textContent = "GO";
                statusEl.className = "go-status go";
                mainStatus.textContent = "Afgerond";
                mainStatus.className = "status-badge status-afgerond";
            } else {
                statusEl.textContent = "NO GO";
                statusEl.className = "go-status pending";
                mainStatus.textContent = "In Behandeling";
                mainStatus.className = "status-badge status-inbehandeling";
            }
        }

        // --- Draw risk bar chart ---
        function drawRiskBarChart() {
            let ctx = document.getElementById('riskBarChart').getContext('2d');
            let data = {
                labels: THEMES.map(t => t.name),
                datasets: [{
                    label: "Risicoscore",
                    data: THEMES.map(t => t.riskScore),
                    backgroundColor: THEMES.map(t =>
                        t.risk === "Hoog" ? "#e03d31" : t.risk === "Midden" ? "#f7b801" : "#49a447"
                    ),
                    borderWidth: 1
                }]
            };
            if(window.riskBar) window.riskBar.destroy();
            window.riskBar = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }
        // --- Draw spider (radar) chart ---
        function drawSpiderDiagram() {
            let ctx = document.getElementById('spiderDiagram').getContext('2d');
            let applicantScores = THEMES.map(t => t.riskScore);
            let populationScores = [70, 60, 50, 65]; // Placeholder
            if(window.spiderChart) window.spiderChart.destroy();
            window.spiderChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: THEMES.map(t => t.name),
                    datasets: [
                        {
                            label: 'Aanvraag',
                            data: applicantScores,
                            fill: true,
                            backgroundColor: 'rgba(51, 122, 183, 0.2)',
                            borderColor: 'rgba(51, 122, 183, 0.8)',
                            pointBackgroundColor: 'rgba(51, 122, 183, 0.9)'
                        },
                        {
                            label: 'Populatie',
                            data: populationScores,
                            fill: true,
                            backgroundColor: 'rgba(247, 184, 1, 0.12)',
                            borderColor: 'rgba(247, 184, 1, 0.85)',
                            pointBackgroundColor: 'rgba(247, 184, 1, 1)'
                        }
                    ]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // --- Decision handling ---
        function showConfirmation(type) {
            const confirmation = document.getElementById('decisionConfirmation');
            if (type === 'approve') {
                document.getElementById('confirmationTitle').textContent = 'Vergunning verleend!';
                document.getElementById('confirmationTitle').style.color = 'var(--success)';
                document.getElementById('confirmationText').innerHTML = `
                    U heeft besloten de vergunning te verlenen. Deze beslissing wordt nu definitief gemaakt.
                    <p style="margin-top:1em;font-weight:bold;">Let op: Deze actie is onomkeerbaar!</p>
                `;
            } else {
                document.getElementById('confirmationTitle').textContent = 'Vergunning geweigerd!';
                document.getElementById('confirmationTitle').style.color = 'var(--danger)';
                document.getElementById('confirmationText').innerHTML = `
                    U heeft besloten de vergunning te weigeren. Deze beslissing wordt nu definitief gemaakt.
                    <p style="margin-top:1em;font-weight:bold;">Let op: Deze actie is onomkeerbaar!</p>
                `;
            }
            confirmation.classList.add('show');
        }

        function finalizeDecision() {
            const confirmation = document.getElementById('decisionConfirmation');
            const isApprove = document.getElementById('confirmationTitle').textContent.includes('verleend');
            
            if (isApprove) {
                // Update all themes to approved
                THEMES.forEach(theme => {
                    if (!themeReviews[theme.name]) {
                        themeReviews[theme.name] = {
                            status: "Goedgekeurd",
                            remark: "Automatisch goedgekeurd bij eindbeslissing",
                            vervolg: "Nee",
                            reviewer: { status: "Goedgekeurd", remark: "", vervolg: "Nee" }
                        };
                    } else {
                        themeReviews[theme.name].status = "Goedgekeurd";
                        themeReviews[theme.name].reviewer.status = "Goedgekeurd";
                    }
                });
                
                statusHistory.push({
                    status: 'Vergunning verleend',
                    date: new Date().toLocaleDateString("nl-NL"),
                    by: "Eindbeslissing"
                });
            } else {
                statusHistory.push({
                    status: 'Vergunning geweigerd',
                    date: new Date().toLocaleDateString("nl-NL"),
                    by: "Eindbeslissing"
                });
            }
            
            confirmation.classList.remove('show');
            renderAccordion();
            updateGoIndicator();
            renderStatusHistory();
            
            alert(`Beslissing is definitief gemaakt: ${isApprove ? 'VERGUNNING VERLEEND' : 'VERGUNNING GEWEIGERD'}`);
        }

        function cancelDecision() {
            document.getElementById('decisionConfirmation').classList.remove('show');
        }

        // --- INIT: Render everything on load ---
        function renderAll() {
            renderAccordion();
            drawRiskBarChart();
            drawSpiderDiagram();
            updateGoIndicator();
            renderMetrics();
            renderStatusHistory();
            renderProcessStatus();
            renderDeadlineTimeline();
            setupDecisionNotes();
        }
        renderAll();

        // --- Window resize: redraw charts for high-DPI nerds ---
        window.addEventListener('resize', function() {
            drawRiskBarChart();
            drawSpiderDiagram();
        });
    </script>
</body>
</html>